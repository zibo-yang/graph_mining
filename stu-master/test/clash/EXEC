#! /bin/sh

doo() { echo "$@" ; $@ ; }

echo 0 >list.exitcode

<LIST.stu cat | 
sed -e '/^[[:space:]]*$/d;/^[[:space:]]*#/d' |
while read -r line ; do

	echo "LINE: $line"

	{
		echo "# Autogenerated by $0 on $(date)"
		echo
		echo "$line"
	} >tmp.stu

	doo rm -f ? list.err

	echo ../../stu.test -f tmp.stu
	../../stu.test -f tmp.stu 2>list.err
	exitcode="$?"
	[ "$exitcode" = 2 ] || {
		echo >&2 "*** error (a) Exit code should be 2 (logical error), but is not"
		echo "exitcode=$exitcode"
		echo 1 >list.exitcode
		exit 1
	}

	grep -qF "'-o'" list.err || {
		echo >&2 "*** error (b) String \"'-o'\" not found in error output"
		echo "Content of error output:"
		echo ________
		cat list.err
		echo ________
		echo 1 >list.exitcode || exit 1
		exit 1
	}

done

rm -f tmp.stu || exit 1

exit $(cat list.exitcode)
